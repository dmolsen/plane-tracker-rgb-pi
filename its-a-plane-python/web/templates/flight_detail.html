{% set aircraft_img = flight.aircraft_image_url or flight.aircraft_image %}
{% set airline_icon = airline_logo_url(flight) or flight.airline_icon or flight.airline_icon_url or flight.airline_logo or flight.airline_logo_url %}
{% set origin_code = flight.origin or flight.origin_iata %}
{% set dest_code = flight.destination or flight.destination_iata %}
{% set origin_label = flight.origin_name or origin_code %}
{% set dest_label = flight.destination_name or dest_code %}
{% set has_destination = dest_label and dest_label|string|lower != "unknown" %}
{% set progress = route_progress(flight.distance_origin, flight.distance_destination) %}
{% set route_total = flight.route_length or (flight.distance_origin + flight.distance_destination if flight.distance_origin is not none and flight.distance_destination is not none else None) or flight.farthest_value %}
{% set trail0 = flight.trail[0] if flight.trail and flight.trail|length > 0 else None %}
{% set trail_alt = trail0.get("alt") if trail0 is mapping else None %}
{% set trail_spd = trail0.get("spd") if trail0 is mapping else None %}
{% set flight_alt = flight.get("altitude") if flight is mapping else (flight.altitude if flight.altitude is defined else None) %}
{% set flight_spd = flight.get("ground_speed") if flight is mapping else (flight.ground_speed if flight.ground_speed is defined else None) %}
{% set display_altitude = flight_alt if flight_alt is not none else (trail_alt if trail_alt is not none else None) %}
{% set display_speed = flight_spd if flight_spd is not none else (trail_spd if trail_spd is not none else None) %}
{% set altitude_trend = flight.get("altitude_trend") if flight is mapping else None %}
{% set speed_trend = flight.get("speed_trend") if flight is mapping else None %}
{% set heading = flight.get("heading") if flight is mapping else (flight.heading if flight.heading is defined else None) %}
{% set is_heli = flight.plane and flight.plane|string|upper|trim|startswith("EC") %}
{% set callsign = flight.callsign if flight.callsign is defined else (flight.get("callsign") if flight is mapping else "") %}
{% set callsign_prefix = callsign|string|upper|trim[:3] %}
{% set is_af1 = callsign|string|upper|trim == "AF1" %}
{% set is_cargo = callsign_prefix in ["FDX", "FX", "UPS", "5X"] %}
{% set is_military = callsign_prefix in ["CNV","RCH","GKA","NVY","RFR","RRR","FAG","ASY","ASF","BAF","BRS","EXB","AFB","CFC","CKJ","FAC","HRZ","CEF","FAE","EGY","EEF","FNF","FAF","GAF","GAM","GNY","HAF","HUF","IFC","IAM","RJZ","LAF","LYF","RMF","FAM","NAF","KIW","NGR","NOW","MJN","FPR","PLF","PNY","AFP","ROF","RFF","RSF","SRB","SAF","SQF","LMG","AME","SVF","SUI","TUN","HVK","UAF"] %}
{% set progress_icon = 'fa-flag-usa' if is_af1 else ('fa-truck' if is_cargo else ('fa-jet-fighter' if is_military else 'fa-helicopter')) %}
{% set total_air_minutes = ((flight.time_estimated_arrival or flight.time_scheduled_arrival) - (flight.time_real_departure or flight.time_scheduled_departure)) / 60 if (flight.time_estimated_arrival or flight.time_scheduled_arrival) and (flight.time_real_departure or flight.time_scheduled_departure) else None %}
{% set total_air_hours = (total_air_minutes // 60) if total_air_minutes is not none else None %}
{% set total_air_min_rem = (total_air_minutes % 60) if total_air_minutes is not none else None %}
{% set speed_units = flight.ground_speed_unit or flight.ground_speed_units or "kts" %}
{% set distance_unit = distance_unit_label() %}
{% set route_heat = "bg-success" if route_total and route_total < 300 else ("bg-warning" if route_total and route_total < 1000 else ("bg-danger" if route_total else "bg-secondary")) %}

<div class="d-flex flex-column flex-md-row align-items-start justify-content-between gap-3 w-100">
  <div class="flex-grow-1 w-100">
    <div class="d-flex align-items-center justify-content-between gap-3 mb-4 w-100">
      <div class="d-flex align-items-center gap-2 flex-grow-1">
        {% if airline_icon %}
          <img src="{{ airline_icon }}" alt="{{ flight.airline }}" class="rounded" style="width: 36px; height: 36px;">
        {% else %}
          <i class="fas {{ progress_icon }} text-muted"></i>
        {% endif %}
        <div class="flex-grow-1">
          <div class="fw-semibold">
            {{ flight.airline or "Unknown Airline" }}
            {% if flight.callsign %}
              <span class="text-muted">{{ flight.callsign }}</span>
            {% endif %}
          </div>
          {% if flight.plane %}
            <div class="small text-muted">{{ flight.plane }}</div>
          {% endif %}
        </div>
      </div>
      {% if aircraft_img %}
        <img src="{{ aircraft_img }}" alt="{{ flight.plane }}" class="img-fluid rounded" style="max-width: 140px;">
      {% endif %}
    </div>

    {% if origin_label or dest_label %}
      <div class="mb-2">
        <div class="row g-3 align-items-start">
          <div class="col-6">
            <div class="fw-semibold fs-4 lh-1">{{ origin_code or "—" }}</div>
            <div class="text-muted small">{{ origin_label or "Unknown" }}</div>
          </div>
          <div class="col-6 text-end">
            <div class="fw-semibold fs-4 lh-1">{{ dest_code or "—" }}</div>
            <div class="text-muted small">{{ dest_label or "Unknown" }}</div>
          </div>
        </div>
      </div>
    {% endif %}

    {% if flight.airline == "Private owner" and flight.callsign %}
      <div class="small mb-2">
        <i class="fas fa-id-card me-1"></i>
        Registration:
        <a href="https://registry.faa.gov/aircraftinquiry/Search/NNumberResult?NNumbertxt={{ flight.callsign }}">
          {{ flight.callsign }}
        </a>
      </div>
    {% endif %}


    {% if progress is not none and has_destination %}
      <div class="mb-4">
        <div class="position-relative" style="height: 6px;">
          <div class="progress" style="height: 6px;">
            <div class="progress-bar bg-info" role="progressbar" style="width: {{ progress }}%;"
                 aria-valuenow="{{ progress }}" aria-valuemin="0" aria-valuemax="100"></div>
          </div>
          <i class="fas {{ progress_icon }} text-muted position-absolute"
             style="left: calc({{ progress }}%); top: 50%; transform: translate(-50%, -50%) scale(0.85);"></i>
        </div>
        <div class="d-flex justify-content-between small text-muted mt-1">
          <span>{{ "{:,.1f}".format(flight.distance_origin) }} {{ distance_unit }} traveled</span>
          <span>{{ "{:,.1f}".format(flight.distance_destination) }} {{ distance_unit }} remaining</span>
        </div>
      </div>
    {% elif flight.distance_origin is not none %}
      <div class="mb-4">
        <div class="position-relative" style="height: 6px;">
          <div class="progress" style="height: 6px;">
            <div class="progress-bar bg-secondary" role="progressbar" style="width: 100%;"
                 aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
          </div>
          <i class="fas {{ progress_icon }} text-muted position-absolute"
             style="left: 100%; top: 50%; transform: translate(-50%, -50%) scale(0.85);"></i>
        </div>
        <div class="d-flex justify-content-between small text-muted mt-1">
          <span>{{ "{:,.1f}".format(flight.distance_origin) }} {{ distance_unit }} traveled</span>
          <span>? remaining</span>
        </div>
      </div>
    {% endif %}

    {% if flight.distance is not none or route_total or flight.timestamp or display_altitude is not none or display_speed is not none or heading is not none %}
      <div class="row row-cols-1 row-cols-md-3 g-2 small text-muted mb-4">
        {% if flight.distance is not none %}
          <div class="col">
            <i class="far fa-circle-dot me-1"></i>
            <strong>Closest approach:</strong> {{ "{:,.1f}".format(flight.distance) }} {{ distance_unit }}
          </div>
        {% endif %}
        {% if display_altitude is not none %}
          <div class="col">
            <i class="fas fa-mountain me-1"></i>
            <strong>Altitude:</strong> {{ "{:,.0f}".format(display_altitude) }} ft
            {% if altitude_trend == "up" %}
              <i class="fas fa-caret-up text-success"></i>
            {% elif altitude_trend == "down" %}
              <i class="fas fa-caret-down text-danger"></i>
            {% elif altitude_trend == "steady" %}
              <span class="text-muted">—</span>
            {% endif %}
          </div>
        {% endif %}
        {% if display_speed is not none %}
          <div class="col">
            <i class="fas fa-gauge-high me-1"></i>
            <strong>Airspeed:</strong> {{ "{:,.0f}".format(display_speed) }} {{ speed_units }}
            {% if speed_trend == "up" %}
              <i class="fas fa-caret-up text-success"></i>
            {% elif speed_trend == "down" %}
              <i class="fas fa-caret-down text-danger"></i>
            {% elif speed_trend == "steady" %}
              <span class="text-muted">—</span>
            {% endif %}
          </div>
        {% endif %}
        {% if heading is not none %}
          <div class="col">
            <i class="fas fa-compass me-1"></i>
            <strong>Heading:</strong> {{ heading | round(0) }}°{% if flight.direction %} {{ flight.direction }}{% endif %}
          </div>
        {% endif %}
        {% if route_total %}
          <div class="col">
            <i class="fas fa-ruler me-1"></i>
            <strong>Route length:</strong> {{ "{:,.1f}".format(route_total) }} {{ distance_unit }}
          </div>
        {% endif %}
        {% if total_air_minutes is not none %}
          <div class="col">
            <i class="fas fa-hourglass-half me-1"></i>
            <strong>Time aloft:</strong>
            {% if total_air_hours >= 1 %}
              {{ total_air_hours | int }}h {{ total_air_min_rem | int }}m
            {% else %}
              {{ total_air_min_rem | int }}m
            {% endif %}
          </div>
        {% endif %}
        {% if flight.timestamp %}
          <div class="col" title="{{ flight.timestamp }}">
            <i class="fas fa-clock me-1"></i>
            <strong>Seen:</strong> {{ time_ago(flight.timestamp) or flight.timestamp }}
          </div>
        {% endif %}
      </div>
    {% endif %}
  </div>
</div>
